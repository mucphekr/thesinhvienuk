<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSE Letter Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="images.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        /* Control Panel */
        .control-panel {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: 95vh;
            overflow-y: auto;
        }

        .control-panel h2 {
            font-family: 'Crimson Text', serif;
            color: #cc0000;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #cc0000;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #cc0000, #ff4444);
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #cc0000;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(204,0,0,0.4);
            transition: transform 0.2s;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-value {
            min-width: 45px;
            text-align: right;
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #cc0000, #990000);
            color: white;
            box-shadow: 0 4px 15px rgba(204,0,0,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(204,0,0,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #333, #555);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
            color: white;
            box-shadow: 0 4px 15px rgba(23,162,184,0.3);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23,162,184,0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fd7e14, #e06600);
            color: white;
            box-shadow: 0 4px 15px rgba(253,126,20,0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253,126,20,0.4);
        }

        .school-section {
            margin-bottom: 20px;
        }

        .btn-lse {
            background: linear-gradient(135deg, #cc0000, #990000);
            color: white;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .btn-lse.active {
            opacity: 1;
            box-shadow: 0 4px 15px rgba(204,0,0,0.4);
            transform: scale(1.02);
        }

        .btn-cam {
            background: linear-gradient(135deg, #8B4513, #654321);
            color: white;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .btn-cam.active {
            opacity: 1;
            box-shadow: 0 4px 15px rgba(139,69,19,0.4);
            transform: scale(1.02);
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #ddd, transparent);
            margin: 20px 0;
        }

        .current-info, .fixed-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .current-info h4, .fixed-info h4 {
            color: #cc0000;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .current-info p, .fixed-info p {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 5px;
        }

        .current-info strong, .fixed-info strong {
            color: #222;
        }

        .fixed-info {
            background: #e8f4e8;
            border: 1px solid #4caf50;
        }

        .fixed-info h4 {
            color: #2e7d32;
        }

        /* Letter Container */
        .letter-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .letter {
            position: relative;
            width: 794px;
            height: 1123px;
            background: white;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .letter img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .overlay-text {
            position: absolute;
            font-family: 'Crimson Text', serif;
            font-weight: 700;
            color: #000;
            white-space: nowrap;
            pointer-events: none;
        }

        #studentName {
            font-size: 16px;
        }

        #dateOfBirth {
            font-size: 16px;
        }

        #dearName {
            font-size: 16px;
        }

        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #999;
            font-size: 1.2rem;
        }

        .placeholder-text p:first-child {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .toast.info {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
        }

        /* Button group */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            body {
                flex-direction: column;
                align-items: center;
            }
            
            .control-panel {
                width: 100%;
                max-width: 500px;
                position: static;
            }
            
            .letter {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h2>üéõÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h2>
        
        <div class="school-section">
            <label style="display:block; font-weight:600; color:#333; margin-bottom:10px;">üéì Ch·ªçn M·∫´u Th∆∞</label>
            <div class="btn-group">
                <button class="btn btn-lse active" id="btnLSE" onclick="selectSchool('lse')">
                    üî¥ LSE
                </button>
                <button class="btn btn-cam" id="btnCam" onclick="selectSchool('cambridge')">
                    üü§ Cambridge
                </button>
            </div>
        </div>

        <div id="mainControls" style="display:none">
            <button class="btn btn-primary" onclick="generateRandom()">
                üé≤ Random Sinh Vi√™n M·ªõi
            </button>

            <div class="btn-group">
                <button class="btn btn-success" onclick="downloadImage()">
                    üì• T·∫£i ·∫¢nh
                </button>
                <button class="btn btn-info" onclick="copyScript()">
                    üìã Copy Script
                </button>
            </div>

            <button class="btn btn-warning" onclick="downloadScript()">
                üíæ T·∫£i Script (.js)
            </button>

            <button class="btn btn-secondary" onclick="resetUsedNames(); updateStats();">
                üîÑ Reset T√™n ƒê√£ D√πng
            </button>
        </div>
        
        <!-- Hidden sliders - gi·ªØ gi√° tr·ªã m·∫∑c ƒë·ªãnh -->
        <input type="hidden" id="nameY" value="240">
        <input type="hidden" id="dobY" value="283">
        <input type="hidden" id="dearY" value="369">

        <div class="current-info">
            <h4>üìã Th√¥ng tin hi·ªán t·∫°i:</h4>
            <p><strong>Tr∆∞·ªùng:</strong> <span id="infoSchool">LSE</span></p>
            <p><strong>T√™n:</strong> <span id="infoName">-</span></p>
            <p><strong>Ng√†y sinh:</strong> <span id="infoDob">-</span></p>
            <p><strong>Email:</strong> <span id="infoEmail">-</span></p>
        </div>

        <div class="current-info" style="background: #e3f2fd; border: 1px solid #2196f3;">
            <h4 style="color: #1565c0;">üìä Th·ªëng k√™ t√™n:</h4>
            <p><strong>ƒê√£ d√πng:</strong> <span id="statsUsed">0</span> / <span id="statsTotal">22,500</span></p>
            <p><strong>C√≤n l·∫°i:</strong> <span id="statsRemaining">22,500</span> t√™n</p>
        </div>
    </div>

    <div class="letter-container">
        <div class="letter" id="letterElement">
            <img id="letterImg" src="" alt="LSE Letter" style="display:none">
            <div class="placeholder-text" id="placeholderText">
                <p>üìÅ</p>
                <p>Ch·ªçn ·∫£nh m·∫´u th∆∞ ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            </div>
            <div class="overlay-text" id="studentName"></div>
            <div class="overlay-text" id="dateOfBirth"></div>
            <div class="overlay-text" id="dearName"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // UK Names Database
        // Database t√™n UK m·ªü r·ªông - 150 First Names
        const firstNames = [
            // Nam ph·ªï bi·∫øn
            'Oliver', 'George', 'Harry', 'Noah', 'Jack', 'Leo', 'Arthur', 'Muhammad', 'Oscar', 'Charlie',
            'James', 'Henry', 'William', 'Lucas', 'Thomas', 'Freddie', 'Theo', 'Archie', 'Joshua', 'Alexander',
            'Edward', 'Benjamin', 'Sebastian', 'Max', 'Ethan', 'Daniel', 'Jacob', 'Isaac', 'Samuel', 'Joseph',
            'Adam', 'Ryan', 'Dylan', 'Luke', 'Nathan', 'Connor', 'Aaron', 'Jamie', 'Matthew', 'Andrew',
            'David', 'Michael', 'Christopher', 'Robert', 'Richard', 'Peter', 'Paul', 'Stephen', 'Mark', 'Simon',
            'Patrick', 'Callum', 'Liam', 'Aiden', 'Finn', 'Owen', 'Hugo', 'Felix', 'Louis', 'Jasper',
            'Alfie', 'Albert', 'Stanley', 'Louie', 'Jude', 'Francis', 'Vincent', 'Edmund', 'Philip', 'Lawrence',
            // N·ªØ ph·ªï bi·∫øn
            'Olivia', 'Amelia', 'Isla', 'Ava', 'Mia', 'Isabella', 'Sophia', 'Grace', 'Lily', 'Freya',
            'Emily', 'Ivy', 'Ella', 'Rosie', 'Florence', 'Willow', 'Poppy', 'Charlotte', 'Evie', 'Daisy',
            'Eleanor', 'Sophie', 'Alice', 'Jessica', 'Harper', 'Matilda', 'Ruby', 'Scarlett', 'Phoebe', 'Elsie',
            'Hannah', 'Emma', 'Lucy', 'Katie', 'Sarah', 'Rebecca', 'Lauren', 'Amy', 'Rachel', 'Nicole',
            'Victoria', 'Elizabeth', 'Catherine', 'Margaret', 'Alexandra', 'Caroline', 'Beatrice', 'Penelope', 'Imogen', 'Harriet',
            'Chloe', 'Zoe', 'Megan', 'Abigail', 'Natalie', 'Jasmine', 'Amber', 'Bethany', 'Molly', 'Anna',
            'Clara', 'Iris', 'Ada', 'Violet', 'Hazel', 'Aurora', 'Luna', 'Stella', 'Esme', 'Thea',
            'Arabella', 'Cordelia', 'Evangeline', 'Genevieve', 'Josephine', 'Adelaide', 'Clementine', 'Rosalind', 'Theodora', 'Winifred'
        ];

        // Database h·ªç UK m·ªü r·ªông - 150 Last Names
        const lastNames = [
            // Top 50 ph·ªï bi·∫øn nh·∫•t
            'Smith', 'Jones', 'Williams', 'Taylor', 'Brown', 'Davies', 'Evans', 'Wilson', 'Thomas', 'Roberts',
            'Johnson', 'Lewis', 'Walker', 'Robinson', 'Wood', 'Thompson', 'White', 'Watson', 'Jackson', 'Wright',
            'Green', 'Harris', 'Cooper', 'King', 'Lee', 'Martin', 'Clarke', 'James', 'Morgan', 'Hughes',
            'Edwards', 'Hill', 'Moore', 'Clark', 'Harrison', 'Scott', 'Young', 'Morris', 'Hall', 'Ward',
            'Turner', 'Carter', 'Phillips', 'Mitchell', 'Patel', 'Adams', 'Campbell', 'Anderson', 'Allen', 'Cook',
            // Th√™m 50 h·ªç ph·ªï bi·∫øn
            'Parker', 'Graham', 'Bell', 'Kelly', 'Simpson', 'Marshall', 'Price', 'Bennett', 'Murray', 'Gibson',
            'Dixon', 'Hunt', 'Palmer', 'Berry', 'Barnes', 'Howard', 'Ross', 'Henderson', 'Coleman', 'Jenkins',
            'Perry', 'Powell', 'Russell', 'Long', 'Patterson', 'Brooks', 'Sanders', 'Griffin', 'Hamilton', 'Spencer',
            'Stone', 'Fox', 'Webb', 'Grant', 'Gordon', 'Ford', 'Wallace', 'Stewart', 'Reynolds', 'Kennedy',
            'Mason', 'Shaw', 'Burns', 'Knight', 'Mills', 'Bailey', 'Richards', 'Chapman', 'Lawrence', 'Gardner',
            // Th√™m 50 h·ªç ƒë·∫∑c tr∆∞ng UK
            'Atkinson', 'Barker', 'Booth', 'Burke', 'Burton', 'Butler', 'Chambers', 'Collins', 'Crawford', 'Cunningham',
            'Davidson', 'Douglas', 'Duncan', 'Ferguson', 'Fletcher', 'Fraser', 'Gallagher', 'Gilbert', 'Griffiths', 'Hawkins',
            'Hayes', 'Holland', 'Hopkins', 'Hudson', 'Hutchinson', 'Johnston', 'Lambert', 'Lane', 'Lloyd', 'Mackenzie',
            'Matthews', 'Maxwell', 'McDonald', 'Morrison', 'Murphy', 'Newman', 'Nicholson', 'Norton', 'Oliver', 'Owens',
            'Pearson', 'Porter', 'Quinn', 'Reid', 'Richardson', 'Robertson', 'Shepherd', 'Stephens', 'Stevens', 'Walsh'
        ];

        // S·ª≠ d·ª•ng localStorage ƒë·ªÉ l∆∞u t√™n ƒë√£ d√πng (tr√°nh tr√πng l·∫∑p)
        const STORAGE_KEY = 'usedStudentNames';
        
        function getUsedNames() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveUsedName(fullName) {
            const used = getUsedNames();
            if (!used.includes(fullName)) {
                used.push(fullName);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(used));
            }
        }
        
        function isNameUsed(fullName) {
            return getUsedNames().includes(fullName);
        }
        
        function resetUsedNames() {
            localStorage.removeItem(STORAGE_KEY);
            showToast('üîÑ ƒê√£ reset danh s√°ch t√™n ƒë√£ d√πng!', 'info');
        }
        
        function getUsedCount() {
            return getUsedNames().length;
        }
        
        function getTotalCombinations() {
            return firstNames.length * lastNames.length;
        }
        
        function updateStats() {
            const total = getTotalCombinations();
            const used = getUsedCount();
            const remaining = total - used;
            
            document.getElementById('statsUsed').textContent = used.toLocaleString();
            document.getElementById('statsTotal').textContent = total.toLocaleString();
            document.getElementById('statsRemaining').textContent = remaining.toLocaleString();
        }

        let currentStudent = {
            firstName: '',
            lastName: '',
            fullName: '',
            dob: '',
            dobParts: { day: 0, month: '', year: 0 },
            email: ''
        };

        // C·∫•u h√¨nh c√°c tr∆∞·ªùng
        const schoolConfig = {
            lse: {
                name: 'London School of Economics and Political Science',
                shortName: 'LSE',
                emailDomain: 'lse.ac.uk'
            },
            cambridge: {
                name: 'University of Cambridge',
                shortName: 'Cambridge',
                emailDomain: 'cam.ac.uk'
            }
        };

        let currentSchool = 'lse';

        function selectSchool(school) {
            currentSchool = school;
            const config = schoolConfig[school];
            
            // C·∫≠p nh·∫≠t UI buttons
            document.getElementById('btnLSE').classList.toggle('active', school === 'lse');
            document.getElementById('btnCam').classList.toggle('active', school === 'cambridge');
            
            // Load ·∫£nh t·ª´ IMAGE_DATA
            imageBase64 = IMAGE_DATA[school];
            
            // Hi·ªÉn th·ªã ·∫£nh
            const img = document.getElementById('letterImg');
            img.src = imageBase64;
            img.style.display = 'block';
            
            // ·∫®n placeholder
            document.getElementById('placeholderText').style.display = 'none';
            
            // Hi·ªán controls
            document.getElementById('mainControls').style.display = 'block';
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            document.getElementById('infoSchool').textContent = config.shortName;
            
            // C·∫≠p nh·∫≠t email n·∫øu ƒë√£ c√≥ sinh vi√™n, ho·∫∑c generate m·ªõi
            if (currentStudent.firstName) {
                currentStudent.email = generateEmail(currentStudent.firstName, currentStudent.lastName);
                document.getElementById('infoEmail').textContent = currentStudent.email;
            } else {
                generateRandom();
            }
            
            console.log('üéì ƒê√£ ch·ªçn tr∆∞·ªùng:', config.name);
        }

        function getRandomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function generateRandomDate() {
            const year = Math.floor(Math.random() * 9) + 1998;
            const month = Math.floor(Math.random() * 12) + 1;
            const day = Math.floor(Math.random() * 28) + 1;
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            return {
                formatted: `${months[month-1]} ${day}, ${year}`,
                day: day,
                month: months[month-1],
                year: year
            };
        }

        function generateEmail(firstName, lastName) {
            const first = firstName.toLowerCase().replace(/[^a-z]/g, '');
            const last = lastName.toLowerCase().replace(/[^a-z]/g, '');
            const domain = schoolConfig[currentSchool].emailDomain;
            return `${first}.${last}@${domain}`;
        }

        function generateRandom() {
            const totalNames = getTotalCombinations();
            const usedCount = getUsedCount();
            
            // Ki·ªÉm tra n·∫øu ƒë√£ d√πng h·∫øt t√™n
            if (usedCount >= totalNames) {
                showToast(`‚ö†Ô∏è ƒê√£ d√πng h·∫øt ${totalNames} t√™n! Click "Reset" ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.`, 'info');
                return;
            }
            
            // T√¨m t√™n ch∆∞a d√πng (t·ªëi ƒëa 100 l·∫ßn th·ª≠)
            let firstName, lastName, fullName;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                firstName = getRandomElement(firstNames);
                lastName = getRandomElement(lastNames);
                fullName = `${firstName} ${lastName}`;
                attempts++;
            } while (isNameUsed(fullName) && attempts < maxAttempts);
            
            // N·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c sau 100 l·∫ßn, t√¨m tu·∫ßn t·ª±
            if (isNameUsed(fullName)) {
                for (const fn of firstNames) {
                    for (const ln of lastNames) {
                        const name = `${fn} ${ln}`;
                        if (!isNameUsed(name)) {
                            firstName = fn;
                            lastName = ln;
                            fullName = name;
                            break;
                        }
                    }
                    if (!isNameUsed(fullName)) break;
                }
            }
            
            // L∆∞u t√™n ƒë√£ d√πng
            saveUsedName(fullName);
            
            const dobData = generateRandomDate();
            const email = generateEmail(firstName, lastName);

            currentStudent = {
                firstName: firstName,
                lastName: lastName,
                fullName: fullName,
                dob: dobData.formatted,
                dobParts: { day: dobData.day, month: dobData.month, year: dobData.year },
                email: email
            };

            document.getElementById('studentName').textContent = fullName;
            document.getElementById('dateOfBirth').textContent = dobData.formatted;
            document.getElementById('dearName').textContent = fullName;
            
            // Update info panel
            document.getElementById('infoName').textContent = fullName;
            document.getElementById('infoDob').textContent = dobData.formatted;
            document.getElementById('infoEmail').textContent = email;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            updateStats();

            updatePosition();
        }

        // Fixed values - l·ªÅ tr√°i ri√™ng cho t·ª´ng m·ª•c
        const FIXED_NAME_LEFT = 52;
        const FIXED_DOB_LEFT = 193;
        const FIXED_DEAR_LEFT = 121;
        const FIXED_FONT_SIZE = 26;

        function updatePosition() {
            const nameY = document.getElementById('nameY').value;
            const dobY = document.getElementById('dobY').value;
            const dearY = document.getElementById('dearY').value;

            const studentNameEl = document.getElementById('studentName');
            const dateOfBirthEl = document.getElementById('dateOfBirth');
            const dearNameEl = document.getElementById('dearName');

            studentNameEl.style.left = FIXED_NAME_LEFT + 'px';
            studentNameEl.style.top = nameY + 'px';
            studentNameEl.style.fontSize = FIXED_FONT_SIZE + 'px';

            dateOfBirthEl.style.left = FIXED_DOB_LEFT + 'px';
            dateOfBirthEl.style.top = dobY + 'px';
            dateOfBirthEl.style.fontSize = FIXED_FONT_SIZE + 'px';

            dearNameEl.style.left = FIXED_DEAR_LEFT + 'px';
            dearNameEl.style.top = dearY + 'px';
            dearNameEl.style.fontSize = FIXED_FONT_SIZE + 'px';
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // Bi·∫øn l∆∞u ·∫£nh ƒë√£ convert sang base64
        let imageBase64 = null;
        
        // Download image
        async function downloadImage() {
            if (!imageBase64) {
                showToast('‚ùå Vui l√≤ng ch·ªçn ·∫£nh m·∫´u th∆∞ tr∆∞·ªõc!', 'error');
                return;
            }
            
            const schoolShort = schoolConfig[currentSchool].shortName;
            const fileName = `${schoolShort}_${currentStudent.firstName}_${currentStudent.lastName}.png`;
            showToast('‚è≥ ƒêang t·∫°o ·∫£nh...', 'info');
            
            try {
                // T·∫°o canvas
                const canvas = document.createElement('canvas');
                const scale = 2;
                canvas.width = 794 * scale;
                canvas.height = 1123 * scale;
                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);
                
                // V·∫Ω background tr·∫Øng
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 794, 1123);
                
                // V·∫Ω ·∫£nh n·ªÅn t·ª´ base64
                await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 794, 1123);
                        resolve();
                    };
                    img.onerror = resolve;
                    img.src = imageBase64;
                });
                
                // V·∫Ω text overlay
                ctx.fillStyle = '#000000';
                ctx.font = `bold ${FIXED_FONT_SIZE}px "Crimson Text", serif`;
                
                const nameY = parseInt(document.getElementById('nameY').value);
                ctx.fillText(currentStudent.fullName, FIXED_NAME_LEFT, nameY + FIXED_FONT_SIZE);
                
                const dobY = parseInt(document.getElementById('dobY').value);
                ctx.fillText(currentStudent.dob, FIXED_DOB_LEFT, dobY + FIXED_FONT_SIZE);
                
                const dearY = parseInt(document.getElementById('dearY').value);
                ctx.fillText(currentStudent.fullName, FIXED_DEAR_LEFT, dearY + FIXED_FONT_SIZE);
                
                // Download
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                showToast(`‚úÖ ƒê√£ t·∫£i ·∫£nh: ${fileName}`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå L·ªói: ' + error.message, 'error');
            }
        }

        // Generate autofill script
        function generateAutofillScript() {
            const s = currentStudent;
            const school = schoolConfig[currentSchool];
            return `(async () => {
    // ============ CONFIG - TH√îNG TIN SINH VI√äN ============
    // Tr∆∞·ªùng: ${school.shortName} - ${school.name}
    const CONFIG = {
        country: "United Kingdom",
        schoolName: "${school.name}",
        firstName: "${s.firstName}",
        lastName: "${s.lastName}",
        birthDay: "${s.dobParts.day}",
        birthMonth: "${s.dobParts.month}",
        birthYear: "${s.dobParts.year}",
        email: "${s.email}",
        targetLanguage: "English (UK)",
        selectors: {
            languageInput: '#changeLanguageSelector-input',
            languageMenu: '#changeLanguageSelector-menu [role="option"]',
            country: [
                'input[name*="country" i]',
                'input[placeholder*="country" i]',
                'input[aria-label*="Country" i]',
                '#sid-country',
                '[id*="country" i]'
            ],
            school: '#sid-college-name',
            schoolMenu: '#sid-college-name-menu [role="option"]',
            firstName: '#sid-first-name',
            lastName: '#sid-last-name',
            birthDayField: '#sid-birthdate-day',
            birthMonthField: '#sid-birthdate__month',
            birthMonthMenu: '#sid-birthdate__month-menu [role="option"]',
            birthYearField: '#sid-birthdate-year',
            email: '#sid-email'
        },
        delays: { default: 500, dropdownWait: 4000, schoolWait: 3500, monthWait: 800, fieldWait: 600, languageWait: 2000 }
    };
    // ============ END CONFIG ============
    
    const delay = ms => new Promise(r => setTimeout(r, ms));
    
    // ============ CHUY·ªÇN ƒê·ªîI NG√îN NG·ªÆ SANG ENGLISH (UK) ============
    const changeLanguage = async () => {
        console.log("üåê ƒêang thay ƒë·ªïi ng√¥n ng·ªØ sang English (UK)...");
        const langInput = document.querySelector(CONFIG.selectors.languageInput);
        
        if (!langInput) {
            console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Language selector");
            return false;
        }
        
        // Ki·ªÉm tra n·∫øu ƒë√£ l√† English (UK) th√¨ b·ªè qua
        if (langInput.value === CONFIG.targetLanguage) {
            console.log("‚úÖ Ng√¥n ng·ªØ ƒë√£ l√† English (UK)");
            return true;
        }
        
        // Click v√†o language selector ƒë·ªÉ m·ªü dropdown
        langInput.focus();
        await delay(200);
        langInput.click();
        await delay(500);
        
        // T√¨m v√† click v√†o option English (UK)
        const menuSels = [
            CONFIG.selectors.languageMenu, 
            '[role="option"]', 
            '.MuiMenuItem-root', 
            'li[role="option"]'
        ];
        
        for (const sel of menuSels) {
            const opts = [...document.querySelectorAll(sel)];
            const target = opts.find(o => {
                const text = o.innerText?.trim() || o.textContent?.trim() || '';
                return text === CONFIG.targetLanguage || text.includes('English (UK)');
            });
            
            if (target) {
                await delay(200);
                target.click();
                console.log("‚úÖ ƒê√£ ch·ªçn ng√¥n ng·ªØ: " + CONFIG.targetLanguage);
                console.log("‚è≥ ƒêang ch·ªù trang c·∫≠p nh·∫≠t ng√¥n ng·ªØ...");
                await delay(CONFIG.delays.languageWait);
                return true;
            }
        }
        
        console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y option English (UK) trong dropdown");
        return false;
    };
    
    const set = async (sel, val) => {
        const el = document.querySelector(sel);
        if (!el) { console.log(\`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y: \${sel}\`); return; }
        el.focus();
        await delay(200);
        const setVal = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, "value").set;
        setVal.call(el, val);
        el.dispatchEvent(new Event("input", { bubbles: true }));
        await delay(150);
        el.dispatchEvent(new Event("change", { bubbles: true }));
        await delay(150);
        el.dispatchEvent(new Event("blur", { bubbles: true }));
        await delay(CONFIG.delays.fieldWait);
        console.log(\`‚úÖ ƒê√£ ƒëi·ªÅn: \${sel} = \${val}\`);
    };
    
    const fillCountry = async () => {
        let countryEl = null;
        for (const sel of CONFIG.selectors.country) {
            countryEl = document.querySelector(sel);
            if (countryEl) break;
        }
        if (!countryEl) { console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng Qu·ªëc gia"); return; }
        
        countryEl.focus();
        await delay(300);
        countryEl.click();
        await delay(300);
        Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, "value").set.call(countryEl, CONFIG.country);
        countryEl.dispatchEvent(new Event("input", { bubbles: true }));
        await delay(200);
        countryEl.dispatchEvent(new Event("change", { bubbles: true }));
        console.log("‚è≥ ƒêang ch·ªù dropdown qu·ªëc gia...");
        await delay(CONFIG.delays.dropdownWait);
        
        const dropdownSelectors = [
            '[role="listbox"] [role="option"]',
            '.MuiAutocomplete-listbox [role="option"]',
            'ul[role="listbox"] li',
            '[data-option-index]'
        ];
        
        let ukOption = null;
        for (const sel of dropdownSelectors) {
            const options = document.querySelectorAll(sel);
            for (const opt of options) {
                const text = opt.innerText?.toLowerCase() || '';
                if (text.includes('united kingdom')) { ukOption = opt; break; }
            }
            if (ukOption) break;
        }
        
        if (ukOption) { 
            ukOption.click(); 
            await delay(600);
            console.log("‚úÖ ƒê√£ ch·ªçn United Kingdom"); 
        } else {
            console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y UK, th·ª≠ ch·ªçn option ƒë·∫ßu ti√™n...");
            for (const sel of dropdownSelectors) {
                const options = document.querySelectorAll(sel);
                if (options.length > 0) { options[0].click(); break; }
            }
        }
        await delay(500);
    };
    
    const pasteSchool = async (val) => {
        const el = document.querySelector(CONFIG.selectors.school);
        if (!el) { console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng h·ªçc"); return; }
        el.focus();
        await delay(300);
        el.click();
        await delay(300);
        Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set.call(el, val);
        el.dispatchEvent(new Event('input', { bubbles: true }));
        await delay(500);
        el.dispatchEvent(new Event('change', { bubbles: true }));
        console.log("‚è≥ ƒêang ch·ªù dropdown tr∆∞·ªùng h·ªçc...");
        await delay(CONFIG.delays.schoolWait);
        
        const menuOption = document.querySelector(CONFIG.selectors.schoolMenu);
        if (menuOption) { 
            menuOption.click(); 
            await delay(800);
            console.log("‚úÖ ƒê√£ ch·ªçn tr∆∞·ªùng: " + CONFIG.schoolName); 
        } else {
            console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y option tr∆∞·ªùng h·ªçc, th·ª≠ l·∫°i...");
            await delay(1500);
            const retry = document.querySelector(CONFIG.selectors.schoolMenu);
            if (retry) { retry.click(); console.log("‚úÖ ƒê√£ ch·ªçn tr∆∞·ªùng (retry)"); }
        }
        await delay(600);
    };
    
    const selectMonth = async () => {
        const el = document.querySelector(CONFIG.selectors.birthMonthField);
        if (!el) { console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√°ng sinh"); return; }
        el.focus();
        await delay(300);
        el.click();
        await delay(CONFIG.delays.monthWait);
        el.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowDown', bubbles: true }));
        await delay(CONFIG.delays.monthWait);
        
        const monthOptions = [...document.querySelectorAll(CONFIG.selectors.birthMonthMenu)];
        const targetMonth = monthOptions.find(o => o.innerText.toLowerCase().includes(CONFIG.birthMonth.toLowerCase()));
        if (targetMonth) { 
            targetMonth.click(); 
            await delay(500);
            console.log(\`‚úÖ ƒê√£ ch·ªçn th√°ng: \${CONFIG.birthMonth}\`); 
        } else {
            console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√°ng, th·ª≠ l·∫°i...");
            await delay(1000);
            const retry = [...document.querySelectorAll(CONFIG.selectors.birthMonthMenu)];
            const retryMonth = retry.find(o => o.innerText.toLowerCase().includes(CONFIG.birthMonth.toLowerCase()));
            if (retryMonth) { retryMonth.click(); console.log(\`‚úÖ ƒê√£ ch·ªçn th√°ng: \${CONFIG.birthMonth} (retry)\`); }
        }
        await delay(400);
    };
    
    console.log("üöÄ B·∫Øt ƒë·∫ßu ƒëi·ªÅn form t·ª± ƒë·ªông...");
    
    console.log("üìç B∆∞·ªõc 0: Chuy·ªÉn ƒë·ªïi ng√¥n ng·ªØ sang English (UK)...");
    await changeLanguage();
    await delay(500);
    
    console.log("üìç B∆∞·ªõc 1: ƒêi·ªÅn qu·ªëc gia...");
    await fillCountry();
    await delay(800);
    
    console.log("üìç B∆∞·ªõc 2: Ch·ªçn tr∆∞·ªùng h·ªçc...");
    await pasteSchool(CONFIG.schoolName);
    await delay(1000);
    
    console.log("üìç B∆∞·ªõc 3: ƒêi·ªÅn h·ªç t√™n...");
    await set(CONFIG.selectors.firstName, CONFIG.firstName);
    await delay(400);
    await set(CONFIG.selectors.lastName, CONFIG.lastName);
    await delay(600);
    
    console.log("üìç B∆∞·ªõc 4: ƒêi·ªÅn ng√†y sinh...");
    await selectMonth();
    await delay(500);
    await set(CONFIG.selectors.birthDayField, CONFIG.birthDay);
    await delay(400);
    await set(CONFIG.selectors.birthYearField, CONFIG.birthYear);
    await delay(600);
    
    console.log("üìç B∆∞·ªõc 5: ƒêi·ªÅn email...");
    await set(CONFIG.selectors.email, CONFIG.email);
    await delay(500);
    
    console.log("‚úÖ Form ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!");
    console.log(\`üìã H·ªç t√™n: \${CONFIG.lastName} \${CONFIG.firstName}\`);
    console.log(\`üìÖ Ng√†y sinh: \${CONFIG.birthDay}/\${CONFIG.birthMonth}/\${CONFIG.birthYear}\`);
    console.log(\`üìß Email: \${CONFIG.email}\`);
    
    // Click verify button
    console.log("üìç B∆∞·ªõc 6: T√¨m v√† click n√∫t x√°c minh...");
    await delay(1500);
    
    const clickVerifyButton = async () => {
        const verifyTexts = [
            'verify my student status',
            'verify student status', 
            'x√°c minh tr·∫°ng th√°i sinh vi√™n',
            'x√°c minh tr·∫°ng th√°i',
            'verify status',
            'verify',
            'x√°c minh',
            'submit',
            'continue',
            'ti·∫øp t·ª•c'
        ];
        
        const buttonSelectors = [
            'button[type="submit"]',
            'button.sid-btn',
            'button[class*="submit"]',
            'button[class*="verify"]',
            'button[class*="primary"]',
            '.sid-submit-wrapper button',
            '[data-testid*="submit"]',
            'form button',
            'button',
            '[role="button"]',
            'input[type="submit"]'
        ];
        
        let foundButton = null;
        
        for (const sel of buttonSelectors) {
            const buttons = document.querySelectorAll(sel);
            for (const btn of buttons) {
                const text = (btn.innerText || btn.textContent || btn.value || '').toLowerCase().trim();
                const ariaLabel = (btn.getAttribute('aria-label') || '').toLowerCase();
                
                for (const verifyText of verifyTexts) {
                    if (text.includes(verifyText) || ariaLabel.includes(verifyText)) {
                        foundButton = btn;
                        console.log('üîç T√¨m th·∫•y n√∫t: "' + (text || ariaLabel) + '"');
                        break;
                    }
                }
                if (foundButton) break;
            }
            if (foundButton) break;
        }
        
        if (!foundButton) {
            const form = document.querySelector('form');
            if (form) {
                const formButtons = form.querySelectorAll('button, input[type="submit"]');
                if (formButtons.length > 0) {
                    foundButton = formButtons[formButtons.length - 1];
                    console.log("üîç S·ª≠ d·ª•ng n√∫t cu·ªëi c√πng trong form");
                }
            }
        }
        
        if (!foundButton) {
            foundButton = document.querySelector('button[type="submit"], button.btn-primary');
            if (foundButton) console.log("üîç S·ª≠ d·ª•ng n√∫t submit/primary");
        }
        
        if (foundButton) {
            foundButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
            await delay(500);
            
            if (foundButton.disabled || foundButton.getAttribute('aria-disabled') === 'true') {
                console.log("‚è≥ N√∫t ƒëang disabled, ch·ªù 3 gi√¢y...");
                await delay(3000);
            }
            
            foundButton.focus();
            await delay(300);
            foundButton.click();
            console.log("‚úÖ ƒê√£ click n√∫t x√°c minh!");
            
            await delay(500);
            foundButton.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
        } else {
            console.log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y n√∫t x√°c minh. Vui l√≤ng click th·ªß c√¥ng.");
        }
    };
    
    await clickVerifyButton();
})();`;
        }

        // Copy script to clipboard
        function copyScript() {
            const script = generateAutofillScript();
            
            // Ph∆∞∆°ng ph√°p 1: S·ª≠ d·ª•ng Clipboard API (modern)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(script).then(() => {
                    showToast('‚úÖ ƒê√£ copy script v√†o clipboard!', 'info');
                }).catch(err => {
                    console.error('Clipboard API error:', err);
                    fallbackCopy(script);
                });
            } else {
                // Ph∆∞∆°ng ph√°p 2: Fallback cho file:// protocol
                fallbackCopy(script);
            }
        }
        
        // Fallback copy method
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('‚úÖ ƒê√£ copy script v√†o clipboard!', 'info');
                } else {
                    showToast('‚ùå Kh√¥ng th·ªÉ copy. H√£y th·ª≠ t·∫£i file .js', 'error');
                }
            } catch (err) {
                console.error('Fallback copy error:', err);
                showToast('‚ùå L·ªói khi copy!', 'error');
            }
            
            document.body.removeChild(textarea);
        }

        // Download script as file
        function downloadScript() {
            const script = generateAutofillScript();
            const blob = new Blob([script], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const fileName = `autofill_${currentStudent.firstName}_${currentStudent.lastName}.js`;
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);
            showToast(`‚úÖ ƒê√£ t·∫£i script: ${fileName}`, 'success');
        }

        // Initialize on page load
        window.onload = function() {
            console.log('üöÄ ƒêang t·∫£i...');
            // C·∫≠p nh·∫≠t th·ªëng k√™
            updateStats();
            // T·ª± ƒë·ªông ch·ªçn LSE khi trang load
            selectSchool('lse');
        };
    </script>
</body>
</html>
